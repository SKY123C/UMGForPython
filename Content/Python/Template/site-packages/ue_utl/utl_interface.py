import logging
import unreal
import traceback
from typing import List
import os
import re
import shutil

asset_tools = unreal.AssetToolsHelpers.get_asset_tools()
asset_registry: unreal.AssetRegistry = unreal.AssetRegistryHelpers.get_asset_registry()
actor_system: unreal.EditorActorSubsystem = unreal.get_editor_subsystem(unreal.EditorActorSubsystem)
asset_system = unreal.get_editor_subsystem(unreal.AssetEditorSubsystem)
seq_subsystem: unreal.LevelSequenceEditorSubsystem = unreal.get_editor_subsystem(unreal.LevelSequenceEditorSubsystem)
editor_asset_system: unreal.EditorAssetSubsystem = unreal.get_editor_subsystem(unreal.EditorAssetSubsystem)

class UnrealInterface:

    def __init__(self, logger: logging.Logger = None):
        self.logger = logger


def add_logger(func):
    def wrapper2(*args, **kwargs):
        instance = args[0]
        result = None
        try:
            result = func(*args, **kwargs)
        except Exception as e:
            if instance.logger:
                instance.logger.error(traceback.format_exc())
            else:
                raise e
        return result
    return wrapper2

class UnrealUTLInterface(UnrealInterface):

    @add_logger
    def create_asset(self, path, name, asset_class, factory):
        """
        创建资产
        """
        if unreal.EditorAssetLibrary.does_asset_exist(f"{path}/{name}"):
            unreal.log_warning(f"Asset {path}/{name} already exists.")
            return None
        return asset_tools.create_asset(name, path, asset_class, factory)

    @add_logger
    def get_asset_by_path(self, path, recursive=False, alllow_class_list=None):
        """
        通过路径获取资产
        """
        if not unreal.EditorAssetLibrary.does_directory_exist(path):
            return []

        asset_data_list = asset_registry.get_assets_by_path(path, recursive=recursive)
        if not asset_data_list:
            return []
        result = []
        for i in asset_data_list:
            if alllow_class_list and i.get_class() in alllow_class_list:
                result.append(i.get_asset())
            elif not alllow_class_list:
                result.append(i.get_asset())
        return result
    
    @add_logger
    def get_all_dep_asset(self, package_list: List[str]):
        dep_stack = package_list
        out_stack = []
        asset_registry = unreal.AssetRegistryHelpers.get_asset_registry()
        while dep_stack:
            current_package = dep_stack.pop()
            if current_package in out_stack:
                continue
            out_stack.append(str(current_package))
            dep_list = asset_registry.get_dependencies(current_package, unreal.AssetRegistryDependencyOptions(True, True, True, True))
            if not dep_list:
                continue
            for dep in dep_list:
                if dep not in out_stack:
                    dep_stack.append(dep)
        res = []
        for i in out_stack:
            if not unreal.load_package(i):
                continue
            if not i.lower().startswith("/game/"):
                continue
            res.append(i)
        return res


    @add_logger
    def export_asset(self, package_list: List[str], export_path: str):
        asset_registry = unreal.AssetRegistryHelpers.get_asset_registry()
        with unreal.ScopedSlowTask(len(package_list), "Exporting Assets") as slow_task:
            slow_task.make_dialog(True)
            content_path = unreal.SystemLibrary.get_project_content_directory()
            for i in package_list:
                try:
                    unreal.EditorLoadingAndSavingUtils.save_packages([unreal.load_package(i)], True)
                except:
                    pass
                
                asset_data_list = asset_registry.get_assets_by_package_name(i)
                if not asset_data_list:
                    self.logger.warning(f"Asset {i} cant be found, skipping export.")
                    continue
                suffix = None
                if asset_data_list[0].get_class() == unreal.World.static_class():
                    suffix = ".umap"
                else:
                    suffix = ".uasset"
                abs_path = re.sub(r"^/Game/", content_path, i, flags=re.IGNORECASE)
                asset_registry.get_assets_by_package_name(i)
                abs_path = abs_path + suffix
                split_res = re.split(content_path, abs_path, flags=re.IGNORECASE)
                if len(split_res) != 2:
                    continue
                new_path = os.path.join(
                        export_path,
                        split_res[-1]
                    )
                
                new_path = os.path.dirname(new_path)
                abs_path = os.path.normpath(abs_path)
                new_path = os.path.normpath(new_path)

                abs_path = abs_path.replace("\\", "/")
                new_path = new_path.replace("\\", "/")
                print(new_path)
                os.makedirs(new_path, exist_ok=True)
                print(abs_path)
                shutil.copy2(
                    abs_path,
                    new_path
                )
                slow_task.enter_progress_frame(1, f"Exporting {i}")