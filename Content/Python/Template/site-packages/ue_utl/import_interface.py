from . import utl_interface
import logging
import unreal
import dataclasses
import pathlib
from typing import List

@dataclasses.dataclass
class ImportInterfaceParams:
    file_path: str = ""
    dst_name: str = ""
    destination_path: str = ""
    replace_existing: bool = True

    def __post_init__(self):
        if not self.destination_path:
            raise ValueError("目标路径不能为空")
        if not self.dst_name:
            self.dst_name = pathlib.Path(self.file_path).stem


@dataclasses.dataclass
class CFXImportParams(ImportInterfaceParams):
    frame_start: int = 0
    frame_end: int = 0
    create_materials: bool = True
    ...

class ImportInterface(utl_interface.UnrealInterface):

    def __init__(self, logger: logging.Logger = None):
        super().__init__(logger)
        self.import_params = None

    @utl_interface.add_logger
    def exec(self, import_params: ImportInterfaceParams):
        self.import_params = import_params
        res = []
        try:
            res = self.import_impl()
        except Exception as e:
            self.logger.error(f"导入失败: {str(e)}")
        self.import_params = None
        return res
    
    def import_impl(self) -> List[unreal.Object]:
        raise NotImplementedError("Subclasses must implement this method.")
    

class ImportCFXInterface(ImportInterface):

    def __init__(self, logger: logging.Logger = None):
        super().__init__(logger)
    
    def import_impl(self) -> List[unreal.GeometryCache]:
        """
        执行导入操作
        """
        res = []
        asset_tool = unreal.AssetToolsHelpers.get_asset_tools()
        task = self.get_cfx_import_task()
        asset_tool.import_asset_tasks([task])
        for i in task.get_editor_property("imported_object_paths"):
            if utl_interface.editor_asset_system.does_asset_exist(i):
                res.append(unreal.load_asset(i))
        return res

    def get_cfx_import_task(self):
        import_task = unreal.AssetImportTask()
        import_task.filename = self.import_params.file_path
        import_task.destination_path = self.import_params.destination_path
        import_task.replace_existing = True
        import_task.automated = True
        import_task.save = True
        import_task.destination_name = self.import_params.dst_name
        options = None
        options = unreal.AbcImportSettings()
        options.material_settings.create_materials = self.import_params.create_materials
        options.import_type = unreal.AlembicImportType.GEOMETRY_CACHE
        options.sampling_settings.sampling_type = unreal.AlembicSamplingType.PER_FRAME
        options.sampling_settings.frame_start = int(self.import_params.frame_start)
        options.sampling_settings.frame_end = int(self.import_params.frame_end)
        options.conversion_settings = unreal.AbcConversionSettings(
            preset=unreal.AbcConversionPreset.CUSTOM, rotation=(90, 0, 0)
        )
        import_task.options = options
        return import_task